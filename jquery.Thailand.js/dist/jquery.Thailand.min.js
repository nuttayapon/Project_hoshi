/**
 * @name jquery.Thailand.js
 * @version 1.5.0
 * @update Apr 20, 2017
 * @website https://github.com/earthchie/jquery.Thailand.js
 * @license WTFPL v.2 - http://www.wtfpl.net/
 *
 * @dependencies: jQuery <https://jquery.com/>
 *              zip.js <https://github.com/gildas-lormeau/zip.js> (optional: for zip database_type only)
 *              typeahead.js <https://twitter.github.io/typeahead.js/>
 *              JQL.js <https://github.com/earthchie/JQL.js>
 **/
$.Thailand=function(a){"use strict";a=$.extend({database:"../database/db.json",database_type:"auto",zip_worker_path:!1,autocomplete_size:20,onLoad:function(){},onDataFill:function(){},$district:!1,$district_code:!1,$amphoe:!1,$amphoe_code:!1,$province:!1,$province_code:!1,$zipcode:!1,$search:!1},a);var b=function(a){var f,b=[],c=[],d=[],e=!1;return a.lookup&&a.words&&(e=!0,b=a.lookup.split("|"),c=a.words.split("|"),a=a.data),f=function(a){function d(a){var b=a.charCodeAt(0);return c[b<97?b-65:26+b-97]}return e?("number"==typeof a&&(a=b[a]),a.replace(/[A-Z]/gi,d)):a},a[0].length?(a.map(function(a){var b=1;3===a.length&&(b=2),a[b].map(function(c){c[b].map(function(e){e[b]=e[b]instanceof Array?e[b]:[e[b]],e[b].map(function(g){var h={district:f(e[0]),amphoe:f(c[0]),province:f(a[0]),zipcode:g};2===b&&(h.district_code=e[1]||!1,h.amphoe_code=c[1]||!1,h.province_code=a[1]||!1),d.push(h)})})})}),d):a},c=function(a,b,d){a+="",b+="";var j,k,l,m,e=0,f=0,g=0,h=a.length,i=b.length;for(j=0;j<h;j+=1)for(k=0;k<i;k+=1){for(l=0;j+l<h&&k+l<i&&a.charAt(j+l)===b.charAt(k+l);)l+=1;l>g&&(g=l,e=j,f=k)}return m=g,m&&(e&&f&&(m+=c(a.substr(0,f),b.substr(0,f),!1)),e+g<h&&f+g<i&&(m+=c(a.substr(e+g,h-e-g),b.substr(f+g,i-f-g),!1))),!1===d?m:a===b?100:h>i?Math.floor(m/h*100):Math.floor(m/i*100)};!function(c){var e,d=a.database_type.toLowerCase();switch("json"!==d&&"zip"!==d&&(d=a.database.split(".").pop()),d){case"json":$.getJSON(a.database,function(a){c(new JQL(b(a)))}).fail(function(b){throw new Error('File "'+a.database+'" is not exists.')});break;case"zip":a.zip_worker_path||$("script").each(function(){var a=this.src.split("/");"zip.js"===a.pop()&&(zip.workerScriptsPath=a.join("/")+"/")}),e=new XMLHttpRequest,e.responseType="blob",e.onreadystatechange=function(){if(4===e.readyState){if(200!==e.status)throw new Error('File "'+a.database+'" is not exists.');zip.createReader(new zip.BlobReader(e.response),function(a){a.getEntries(function(a){a[0].getData(new zip.BlobWriter,function(a){var d=new FileReader;d.onload=function(){c(new JQL(b(JSON.parse(d.result))))},d.readAsText(a)})})})}},e.open("GET",a.database),e.send();break;default:throw new Error('Unknown database type: "'+a.database_type+'". Please define database_type explicitly (json or zip)')}}(function(b){var d,e,f={empty:" ",suggestion:function(a){return a.zipcode&&(a.zipcode=" » "+a.zipcode),"<div>"+a.district+" » "+a.amphoe+" » "+a.province+a.zipcode+"</div>"}},g=function(b,c){for(d in a)e=d.replace("$",""),d.indexOf("$")>-1&&a.hasOwnProperty(d)&&a[d]&&c[e]&&a[d].typeahead("val",c[e]).trigger("change");"function"==typeof a.onDataFill&&(delete c.likely,a.onDataFill(c))};for(d in a)d.indexOf("$")>-1&&"$search"!==d&&a.hasOwnProperty(d)&&a[d]&&a[d].typeahead({hint:!0,highlight:!0,minLength:1},{limit:a.autocomplete_size,templates:f,source:function(a,c){var d=[],e=this.$el.data("field");try{d=b.select("*").where(e).match("^"+a).orderBy(e).fetch()}catch(a){}c(d)},display:function(a){return a[this.$el.data("field")]}}).parent().find(".tt-dataset").data("field",d.replace("$",""));a.$search&&a.$search.typeahead({hint:!0,highlight:!0,minLength:2},{limit:a.autocomplete_size,templates:f,source:function(a,d){var f,e=[];try{e=new JQL(e.concat(b.select("*").where("district").match(a).fetch()).concat(b.select("*").where("amphoe").match(a).fetch()).concat(b.select("*").where("province").match(a).fetch()).concat(b.select("*").where("zipcode").match(a).fetch()).filter(function(a,b,c){for(f=0;f<c.length;f+=1)if(b!==f&&c[f].amphoe===a.amphoe&&c[f].district===a.district)return!1;return!0}).map(function(b){return b.likely=[5*c(a,b.district),3*c(a,b.amphoe.replace(/^เมือง/,"")),c(a,b.province),c(a,b.zipcode)].reduce(function(a,b){return Math.max(a,b)}),b})).select("*").orderBy("likely desc").fetch()}catch(a){}d(e)},display:function(a){return""}});for(d in a)d.indexOf("$")>-1&&a.hasOwnProperty(d)&&a[d]&&a[d].bind("typeahead:select typeahead:autocomplete",g).blur(function(){this.value||$(this).parent().find(".tt-dataset").html("")});"function"==typeof a.onLoad&&a.onLoad(),"function"==typeof a.onComplete&&a.onComplete()})};